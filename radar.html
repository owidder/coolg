<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="./bower_components/materialize/dist/css/materialize.css" media="screen,projection"/>
    <link rel="stylesheet" type="text/css" href="./css/style.css"/>
    <link rel="stylesheet" type="text/css" href="./css/material-icons.css"/>

    <script src="./bower_components/bottlejs/dist/bottle.js"></script>
    <script>var bottle = new Bottle();</script>

    <script src="./bower_components/d3/d3.js"></script>
    <script src="./bower_components/lodash/dist/lodash.js"></script>
    <script src="./bower_components/jquery/dist/jquery.js"></script>
    <script src="./bower_components/pouchdb/dist/pouchdb.js"></script>
    <script src="./bower_components/handlebars/handlebars.js"></script>

</head>

<body>
<div class="container">
    <div class="row">
        <div class="col s2">
            <div id="form-segments"></div>
            <br>
            <div id="form-rings"></div>
            <br>
            <a onclick="reset()" class="waves-effect waves-light btn">Reset</a>
        </div>
        <div class="col s8">
            <div class="svg"></div>
        </div>
        <div class="col s2">
            <div id="form-items"></div>
        </div>
    </div>
</div>

<script id="input-segments" type="text/x-handlebars-template">
    <b>Segments</b>
    {{#each segments}}
    <table>
        <tr class="input">
            <td class="input">
                <input onmouseover="highlightBackgroundOn('{{id}}')"
                       onmouseout="highlightBackgroundOff()"
                       onkeyup="segmentNameChanged('{{id}}')"
                       class="input"
                       placeholder="Segment name"
                       id="{{id}}"
                       type="text"
                       class="validate"
                       value="{{name}}">
            </td>
            <td class="input">
                <a onclick="removeSegment('{{id}}')" class="input" href="#">
                    <i class="material-icons">delete_forever</i>
                </a>
            </td>
            <td class="input">
                <a onclick="addSegmentAfterId('{{id}}')" class="input" href="#">
                    <i class="material-icons">note_add</i>
                </a>
            </td>
        </tr>
    </table>
    {{/each}}
</script>

<script id="input-rings" type="text/x-handlebars-template">
    <b>Rings</b>
    {{#each rings}}
    <table>
        <tr class="input">
            <td class="input">
                <input onmouseover="highlightBackgroundOn('{{id}}')"
                       onmouseout="highlightBackgroundOff()"
                       onkeyup="ringNameChanged('{{id}}')"
                       class="input"
                       placeholder="Ring name"
                       id="{{id}}"
                       type="text"
                       class="validate"
                       value="{{name}}">
            </td>
            <td class="input">
                <a onclick="removeRing('{{id}}')" class="input" href="#">
                    <i class="material-icons">delete_forever</i>
                </a>
            </td>
            <td class="input">
                <a onclick="addRingAfterId('{{id}}')" class="input" href="#">
                    <i class="material-icons">note_add</i>
                </a>
            </td>
        </tr>
    </table>
    {{/each}}
</script>

<script id="input-items" type="text/x-handlebars-template">
    <b>Trends</b>
    {{#each items}}
    <table>
        <tr class="input">
            <td class="input">
                <input onkeyup="itemNameChanged('{{id}}')" class="input" placeholder="Trend name" id="{{id}}" type="text" class="validate" value="{{name}}">
            </td>
            <td class="input">
                <a onclick="removeItem('{{id}}')" class="input" href="#">
                    <i class="material-icons">delete_forever</i>
                </a>
            </td>
            <td class="input">
                <a onclick="addItemAfterId('{{id}}')" class="input" href="#">
                    <i class="material-icons">note_add</i>
                </a>
            </td>
        </tr>
    </table>
    {{/each}}
</script>

<script src="./js/db.js"></script>
<script src="./js/SvgLegend.js"></script>
<script src="./js/SimplePromise.js"></script>
<script src="./js/context.js"></script>
<script src="./js/util.js"></script>
<script src="./js/Background.js"></script>
<script src="./js/Items.js"></script>
<script src="./js/Field.js"></script>

<script>

    /* gobal $ */
    /* global bottle */

    var radarId = bottle.container.util.param("radarId", 1);
    bottle.container.context.radarId = radarId;

    var field = new bottle.container.Field();

    var background = new bottle.container.Background(field);
    var items = new bottle.container.Items(field);

    function segmentNameChanged(id) {
        var newName = $("#" + id).val();
        background.changeSegmentName(id, newName);
    }

    function ringNameChanged(id) {
        var newName = $("#" + id).val();
        background.changeRingName(id, newName);
    }

    function removeSegment(id) {
        background.removeSegment(id);
    }

    function removeRing(id) {
        background.removeRing(id);
    }

    function addSegmentAfterId(id) {
        background.addSegmentAfterId(id);
    }

    function addRingAfterId(id) {
        background.addRingAfterId(id);
    }

    function itemNameChanged(id) {
        var newName = $("#" + id).val();
        items.changeItemName(id, newName);
    }

    function addItemAfterId(id) {
        items.addItemAfterId(id);
    }

    function removeItem(id) {
        items.removeItem(id);
    }

    function highlightBackgroundOn(id) {
        background.highlightOn(id);
    }

    function highlightBackgroundOff() {
        background.highlightOff();
    }

    function reset() {
        bottle.container.db.deleteFromDb().then(function () {
            window.location.reload();
        }, function () {
            window.location.reload();
        });
    }

    background.load();
    items.load();

</script>
</body>
</html>