<!DOCTYPE html>
<html>
<head>
    <title>Dancing dots</title>
    <link rel="stylesheet" href="../../bower_components/Materialize/dist/css/materialize.min.css">
    <script src="../../bower_components/jquery/dist/jquery.min.js"></script>
    <script src="../../bower_components/js-url/url.min.js"></script>
    <script src="../../lib/d3.v4.min.js"></script>
    <script src="../../bower_components/Materialize/dist/js/materialize.min.js"></script>
    <script src="SimplePromise.js"></script>
    <script src="SimpleEvent.js"></script>
    <script src="buildGraph.js"></script>
    <script src="move.js"></script>
    <style>
        .link {
            stroke: #2E2E2E;
            stroke-width: 2px;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
        }
        .textClass {
            stroke: #323232;
            font-family: "Lucida Grande", "Droid Sans", Arial, Helvetica, sans-serif;
            font-weight: normal;
            stroke-width: .5;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="graph"></div>

<script>
    window.addEventListener("DOMContentLoaded", function() {
        var w = $(window).width();
        var h = $(window).height();

        var buildGraph = new BuildGraph(w, h, "svg", "graph", 10);

        function randomRunColor() {
            return Math.random() < 0.75 ? "green" : "red";
        }

        var i;
        var stopEvents = [];
        var MAX = 2;
        var r = Math.min(w, h) / 2 - 50;
        var ANGLE_STEP = 360 / MAX;
        var step = Math.random() < 0.5 ? 1 : -1;

        function addRunsRecursively(ctr, ids, movePromises) {
            var p = new SimplePromise();
            var id = "Node-" + ctr;
            ids.push(id);
            buildGraph.addNewRun(id, randomRunColor());
            var waitTime = Math.random() * 5000;
            if(ctr < MAX-1) {
                setTimeout(function() {
                    beginMoveForAll(buildGraph.simulation).then(function () {
                        var prom = moveTo(buildGraph.simulation, id, w * Math.random(), h * Math.random(), 5000, 1, 2000);
                        movePromises.push(prom);
                        prom.then(function () {
                            endMoveForAll(buildGraph.simulation).then(function () {
                                addRunsRecursively(ctr+1, ids, movePromises);
                            });
                        });
                    })
                }, waitTime);
            }
            else {
                Promise.all(movePromises).then(function () {
                    p.resolve(ids);
                });
            }

            return p.promise;
        }

        addRunsRecursively(0, [], []).then(function(ids) {
            setTimeout(function() {
                moveAllOnCircleRecursive(buildGraph.simulation, ids, cx, cy, r, [], step);
            }, 3000);
        })
    }, false);
</script>

</body>
</html>